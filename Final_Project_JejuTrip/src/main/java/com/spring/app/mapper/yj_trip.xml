<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(네임스페이스명은 프로젝트 전체내에서 유일해야 한다!!!!!) ====  절대  ; 쓰지마라 !!!!!!!!!! 
메퍼가 바뀌면 무조건  WAS를 껐다 켜야한다!!!!!!!!! -->
<mapper namespace="yj_trip">


	<!-- 맛집 리스트 띄우기 -->
	<resultMap type="HashMap" id="categoryMap">
		<result property="rno" 					column="rno"		 		javaType="String" />
		<result property="food_store_code" 		column="food_store_code" 	javaType="String" />
		<result property="local_status" 		column="local_status" 		javaType="String" />
		<result property="food_name" 			column="food_name" 			javaType="String" />
		<result property="food_content" 		column="food_content" 		javaType="String" />
		<result property="food_businesshours" 	column="food_businesshours" javaType="String" />
		<result property="food_mobile" 			column="food_mobile" 		javaType="String" />
		<result property="food_address" 		column="food_address" 		javaType="String" />
		<result property="food_main_img" 		column="food_main_img" 		javaType="String" />
		<result property="review_division" 		column="review_division" 	javaType="String" />
		<result property="food_category" 		column="food_category" 		javaType="String" />
		<result property="filename" 			column="filename" 			javaType="String" />
		<result property="orgfilename" 			column="orgfilename" 		javaType="String" />
		<result property="filesize" 			column="filesize" 			javaType="String" />
	</resultMap>
	<select id="viewFoodstoreList" parameterType="HashMap" resultType="com.spring.app.trip.domain.FoodstoreVO">
		SELECT rno, food_store_code, local_status, food_name, food_content, food_businesshours, food_mobile
		     , food_address, food_main_img, review_division, food_category
		     , filename, orgfilename, filesize
		FROM
		(
			select rownum as RNO, food_store_code, local_status, food_name, food_content, food_businesshours, food_mobile
			     , substr(food_address, 0, instr(food_address, ' ', 1, 2)-1) AS food_address
			     , food_main_img, review_division, food_category
			     , filename, orgfilename, filesize   
			from tbl_food_store
			where 1=1
		
			<!-- 카테고리 체크박스 다중선택 -->
			<if test="arr_category != null">
				AND food_category IN
				<foreach collection="arr_category" index="i" open="(" separator="," close=")">
					'${arr_category[i]}'
				</foreach>
			</if>
			<!-- 지역 체크박스 다중선택 -->
			<if test="arr_area != null">
				AND local_status IN
				<foreach collection="arr_area" index="i" open="(" separator="," close=")">
					'${arr_area[i]}'
				</foreach>
			</if>
			<!-- 검색 -->
			<if test="searchWord != ''">
				AND lower(food_name) like '%'||lower(#{searchWord})||'%'
			</if>
		)
		WHERE rno between #{startRno} and #{endRno}
		<!-- 오름차순 정렬 -->
		<if test="orderValue_asc != null">
			ORDER BY ${orderType} ${orderValue_asc}
		</if>
		<!-- 내림차순 정렬 -->
		<if test="orderValue_desc != null">
			ORDER BY ${orderType} ${orderValue_desc}
		</if>
		<if test="orderType == null">
			ORDER BY food_store_code
		</if>
	</select>
	
	
	<!-- 맛집 총 개수 알아오기  -->
	<select id="getTotalCount" parameterType="HashMap" resultType="int">
		select count(*)
		from tbl_food_store
	</select>
	
	
	<!-- 맛집 상세 조회하기 -->
	<select id="viewfoodstoreDetail" parameterType="HashMap" resultType="com.spring.app.trip.domain.FoodstoreVO">
		select food_store_code, local_status, food_name, food_category, food_content, food_address, food_businesshours, food_mobile
			 , food_main_img, review_division
		from tbl_food_store
		<!-- 맛집 리스트에서 이동한 경우 -->
		<if test="food_store_code != ''">
			where food_store_code = #{food_store_code}
		</if>
		<!-- 맛집 추천에서 이동한 경우 -->
		<if test="food_store_code == ''">
			where food_store_code = #{random_recommend_code}
		</if>
	</select>
	
	
	<!-- 맛집 상세 추가 이미지  -->
	<resultMap type="HashMap" id="imgMap">
		<result property="food_add_code" 		column="food_add_code" 		javaType="String" />	
		<result property="fk_food_store_code" 	column="fk_food_store_code" javaType="String" />	
		<result property="food_add_img" 		column="food_add_img" 		javaType="String" />	
	</resultMap>
	<select id="viewfoodaddImg" parameterType="HashMap" resultMap="imgMap">
		SELECT I.food_add_img
		FROM 
		(
		select food_store_code, food_name
		from tbl_food_store
		<!-- 맛집 리스트에서 이동한 경우 -->
		<if test="food_store_code != ''">
			where food_store_code = #{food_store_code}
		</if>
		<!-- 맛집 추천에서 이동한 경우 -->
		<if test="food_store_code == ''">
			where food_store_code = #{random_recommend_code}
		</if>
		)S
		JOIN tbl_food_add_img I
		ON S.food_store_code = I.fk_food_store_code
		ORDER BY food_add_img
	</select>
	
	
	<!-- 맛집 랜덤 추천 -->
	<select id="randomRecommend" parameterType="HashMap" resultType="com.spring.app.trip.domain.FoodstoreVO">
		<![CDATA[
			select food_store_code, local_status, food_name, food_content, food_businesshours, food_mobile
				 , food_address, food_main_img, review_division, food_category
			from (
			    select food_store_code, local_status, food_name, food_content, food_businesshours, food_mobile
					 , food_address, food_main_img, review_division, food_category
			    from tbl_food_store
			    order by DBMS_RANDOM.RANDOM
			)
			where rownum <= 3
		]]> 
	</select>
	


</mapper>
